{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <!-- FullCalendar JS -->
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
     <!-- JavaScript ì—°ê²° -->
    <script src="{% static 'js/script.js' %}"></script>
    !-- ğŸ”— Bootstrap 5 CSS (head ì•ˆì—) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <title>ë‚˜ì—ê²Œ ì“°ëŠ” í¸ì§€</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v={{ time }}">
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; }
        /* FullCalendar ì „ì²´ ìº˜ë¦°ë” ë°°ê²½ */


    </style>
</head>
<body>
    <header style="position: relative;">
        <h1 style=" font-family: 'KCC-Sonkeechung';">A Letter To Myself</h1>
    </header>
    <!-- í–„ë²„ê±° ë²„íŠ¼ -->
    <div class="btn">
        <img src="{% static 'images/poststamp.png' %}" alt="ìš°í‘œìŠ¤í‹°ì»¤ UI" width="50px">
    </div>

    <!-- ë©”ë‰´ ë°”ê¹¥ì„ í´ë¦­í•˜ë©´ ë‹«í˜ -->
    <div class="page_cover"></div>

    <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
    <div id="menu">
        <ul class="nav">
            <li><a href="http://127.0.0.1:8000/writing">í¸ì§€ ì“°ê¸°</a></li>
            <li><a href="http://127.0.0.1:8000/letters">í¸ì§€ ëª©ë¡</a></li>
            <li><a href="http://127.0.0.1:8000/routine">í¸ì§€ ë£¨í‹´</a></li>
            {% if user.is_authenticated %}
                <a href="{% url 'commons:mypage' %}">ë§ˆì´í˜ì´ì§€</a>
            {% else %}
                <a href="{% url 'commons:login' %}">ë¡œê·¸ì¸</a>
            {% endif %}
            <li>
                {% if user.is_authenticated %}
                <a href="{% url 'commons:logout' %}">{{ user.username }} (ë¡œê·¸ì•„ì›ƒ)</a>
                
                {% endif %}
            </li>
            <li><a href="{% url 'commons:signup' %}">íšŒì›ê°€ì…</a></li>
            
        </ul>
    </div>

    <!-- ì „ì²´ wrapper -->
<div class="mypage-container">

  <!-- í”„ë¡œí•„ ì¹´ë“œ -->
  <div class="profile-card">
    <div class="profile-banner"></div> <!-- ë°°ê²½ ì´ë¯¸ì§€ -->
    <div class="profile-info">
      <img src="{% static 'images/basicProfile.png' %}" class="profile-img">
      <h2>{{ user.username }}</h2>
      <p class="email">{{ user.email }}</p>
    
      <p class="intro">í•œì¤„ì†Œê°œ ë˜ëŠ” MBTI ë“±</p>
    </div>
  </div>

  <!-- í™œë™ í†µê³„ -->
  <div class="activity-stats">
    <div class="stat-box"><strong>{{ letter_count }}</strong><p>í¸ì§€</p></div>
    <div class="stat-box"><strong>{{ most_frequent_mood }}</strong><p>ìµœê·¼ ë‚˜ì˜ ê°ì •</p></div>
    <div class="stat-box"><strong>{{ routine_count }}</strong><p>ë£¨í‹´</p></div>
  </div>

  <!-- ë³´ê´€í•¨ or ì„¹ì…˜ íƒ­ -->
  <div class="section-tabs">
    <button class="tab-btn active" data-target="letters">ê°ì •ë¶„ì„</button>
    <button class="tab-btn" data-target="calendar">ë£¨í‹´ ìº˜ë¦°ë”</button>
    <button class="tab-btn" data-target="profile">í”„ë¡œí•„</button>
  </div>

  <!-- íƒ­ ì½˜í…ì¸  -->
  <div class="section-content">

    <div id="letters" class="tab-section active">
        <div class="chatbot-section">
            <h2>ğŸ“œ ë‹¹ì‹ ì˜ ê°ì • ë¶„ì„ ê²°ê³¼</h2>
            {% if most_frequent_mood %}
                <p>ê°€ì¥ ë§ì´ ëŠë‚€ ê°ì •ì€ <strong>{{ most_frequent_mood }}</strong> ì…ë‹ˆë‹¤.</p>
                {% else %}
                <p>ì•„ì§ ê¸°ë¡ëœ ê°ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
             ê°ì • ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ëŠ” ê·¸ë˜í”„ 
            <canvas id="moodChart"></canvas>
        
           
            <p style="white-space: pre-line;">{{ comfort_message }}</p>
            <div class="recommendations">
                <h3>ğŸ¬ ì¶”ì²œ ì˜í™” & ğŸµ ì¶”ì²œ ìŒì•…</h3>
                <p style="white-space: pre-line;">{{ recommendations }}</p>
            </div>
        </div>
    </div>
    <!-- ğŸ“… ìº˜ë¦°ë” íƒ­ -->
    <div id="calendar" class="tab-section">
        <div class="routine_calendar">
        <!-- <h2>ğŸ“… í¸ì§€ ë£¨í‹´ ìº˜ë¦°ë”</h2> -->
        <div id="calendarArea"></div>  <!-- âœ… ì´ê³³ì— ë Œë”ë§ -->
        </div>
    </div>

<!-- ğŸ“… ë£¨í‹´ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="routineModal" tabindex="-1" aria-labelledby="routineModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="routineModalLabel">ë£¨í‹´ ì¼ì •</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body" id="modalRoutineContent">
        <!-- ì—¬ê¸°ì— ì´ë²¤íŠ¸ ì •ë³´ê°€ ë™ì ìœ¼ë¡œ ë“¤ì–´ê° -->
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('moodChart').getContext('2d');
    var chartData = {
        labels: [{% for mood in mood_counts %}"{{ mood.mood }}",{% endfor %}],
        datasets: [{
            label: 'ê°ì • ê¸°ë¡ íšŸìˆ˜',
            data: [{% for mood in mood_counts %}{{ mood.count }},{% endfor %}],
            backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(255, 159, 64, 0.2)',
            'rgba(255, 205, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(153, 102, 255, 0.2)',
            'rgba(201, 203, 207, 0.2)'
            ],
            borderColor: [
            'rgb(255, 99, 132)',
            'rgb(255, 159, 64)',
            'rgb(255, 205, 86)',
            'rgb(75, 192, 192)',
            'rgb(54, 162, 235)',
            'rgb(153, 102, 255)',
            'rgb(201, 203, 207)'
            ],
            borderWidth: 1
                }]
    };

    new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
        indexAxis: 'y',
    }
    });
    
</script>

<!-- #ìº˜ë¦°ë” -->
<script>
   document.addEventListener('DOMContentLoaded', function () {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabSections = document.querySelectorAll(".tab-section");
  const calendarEl = document.getElementById('calendarArea');

  let calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'ko',
    events: '/api/routines/',   // âœ… Django APIì—ì„œ ë£¨í‹´ ë°ì´í„° ë°›ì•„ì˜¤ëŠ” ì£¼ì†Œ
    height: 550,
    eventColor: '#ffc0cb',

    
    dateClick: function(info) {
      const clickedDate = info.dateStr;
      const events = calendar.getEvents();

      const toDateString = (dateObj) => {
      return dateObj.getFullYear() + '-' +
            String(dateObj.getMonth() + 1).padStart(2, '0') + '-' +
            String(dateObj.getDate()).padStart(2, '0');
    };

    const eventsOnDate = events.filter(event => {
      const eventDate = toDateString(event.start);  // ë¡œì»¬ ê¸°ì¤€
      return eventDate === clickedDate;
    });


      const modalBody = document.getElementById("modalRoutineContent");
      const modalTitle = document.getElementById("routineModalLabel");

      if (eventsOnDate.length > 0) {
        modalTitle.innerText = `${clickedDate} ì¼ì •`;

        const htmlList = eventsOnDate.map(ev => `<li>${ev.title}</li>`).join('');
        modalBody.innerHTML = `<ul>${htmlList}</ul>`;
      } else {
        modalTitle.innerText = `${clickedDate}`;
        modalBody.innerHTML = `<p>ë“±ë¡ëœ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤. ë£¨í‹´ì„ ë“±ë¡í•˜ì„¸ìš”!</p>`;
      }

      // ëª¨ë‹¬ ì—´ê¸° (Bootstrap 5)
      const modal = new bootstrap.Modal(document.getElementById('routineModal'));
      modal.show();
    }

  });

  

  // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
  tabButtons.forEach(btn => {
    btn.addEventListener("click", function () {
      tabButtons.forEach(b => b.classList.remove("active"));
      tabSections.forEach(s => s.classList.remove("active"));

      this.classList.add("active");
      const targetId = this.dataset.target;
      document.getElementById(targetId).classList.add("active");

      // calendar íƒ­ì´ ì—´ë¦´ ë•Œë§Œ render() ì‹¤í–‰
      if (targetId === "calendar") {
        setTimeout(() => {
          calendar.render();
        }, 10);
      }
    });
  });

  // ìµœì´ˆ ë¡œë”© ì‹œ calendar íƒ­ì´ ë³´ì´ë©´ render()
  if (document.getElementById("calendar").classList.contains("active")) {
    calendar.render();
  }
});




  </script>
  



  <!-- ğŸ”— Bootstrap 5 JS + Popper (body ëì—) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
